<!DOCTYPE html><html>

<head>
<meta charset="utf-8">
<title>README</title>
<style type="text/css">
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>
</head>
<body>
<p><img src="cs171-logo.png" width="200"></p>

<p>&nbsp;</p>

<h1 id="toc_0">Lab 8</h1>

<h3 id="toc_1">Learning Objectives</h3>

<ul>
<li>Know how to integrate a sophisticated <em>event handling mechanism</em> to connect multiple visualizations components and UI elements with each other</li>
<li>Get more experience with <em>brushing</em> and <em>zooming</em> in D3</li>
<li>Get a better understanding of <em>system design</em> and <em>code structure</em> in order to be able to create larger visualization system</li>
</ul>

<h3 id="toc_2">Prerequisites</h3>

<ul>
<li><p>You have watched the following videos:</p>

<ul>
<li>jQuery Tutorial #1 - <a href="https://www.youtube.com/watch?v=hMxGhHNOkCU">https://www.youtube.com/watch?v=hMxGhHNOkCU</a></li>
<li>jQuery Tutorial #2 - <a href="https://www.youtube.com/watch?v=G-POtu9J-m4">https://www.youtube.com/watch?v=G-POtu9J-m4</a></li>
<li><em>[Optional]</em> jQuery Tutorial #3 - <a href="https://www.youtube.com/watch?v=Cc3K2jDdKTo">https://www.youtube.com/watch?v=Cc3K2jDdKTo</a></li>
<li><em>[Optional]</em> jQuery Tutorial #4 - <a href="https://www.youtube.com/watch?v=LYKRkHSLE2E">https://www.youtube.com/watch?v=LYKRkHSLE2E</a></li>
</ul></li>
<li><p>You already have an overview of the <em>My World 2015</em> project and the datasets we are going to use today (<a href="http://cs171.org/2016/assets/material/cs171-lab8-reading.pdf">http://cs171.org/2016/assets/material/cs171-lab8-reading.pdf</a>)</p></li>
<li><p>You have successfully filled in the pre-quiz for the 8th lab.</p></li>
</ul>

<p>In the last weeks you have learned how to implement common visualization types in D3. You have learned how to use brushing and you have linked multiple reusable views with each other by using a very basic event handler (global <em>brush</em> function). This lab is built on all these fundamentals. You will learn how to structure a larger visualization system and how to integrate an event handling mechanism, which you will very likely need for your final projects. Due to the extensive example, which is necessary to demonstrate how to structure larger systems, we will provide a template with many completed parts. Your main tasks will focus on the structure, the interactions and the event handling components. However, please make sure that you understand the code in the provided templates, and take your time to read through it!</p>

<h2 id="toc_3">United Nations - My World 2015</h2>

<p>You will build a system that allows interactive selection of time slices of the poll data from the years 2012 and 2013. For the selected time period, the visualization will show the amount of votes per priority/choice from the poll data in addition to a histogram of participant&#39;s age for the given selection. </p>

<p><em>Preview of the final system:</em></p>

<p><img src="cs171-lab8-preview.gif?raw=true" alt="Lab 8 - Preview" title="Lab 8 - Preview"></p>

<h3 id="toc_4">Data</h3>

<p>We have already aggregated and transformed the original datasets to make the data format a better fit to the tasks we want to perform. You should know the rough structure and the contained information from the pre-reading. </p>

<ul>
<li><code>perDayData.json</code></li>
<li><code>myWorldFields.json</code> <em>(= metadata about the 15 priorities)</em></li>
</ul>

<h3 id="toc_5">Template</h3>

<p>This lab combines many concepts that we have introduced during the last weeks and gives you all the tools you need to build a larger visualization system on the web. The provided template is similar to the template from lab 6 where we have worked with multiple coordinated views for the first time. It is based on Bootstrap and it contains a basic HTML structure, some CSS rules and pieces of JS code.</p>

<p>The controller and the data loading scripts are in the <code>main.js</code> file.</p>

<p>You will implement the visualizations again as reusable components (JS objects) in separate files:</p>

<ul>
<li><code>agevis.js</code></li>
<li><code>countvis.js</code></li>
<li><code>priovis.js</code></li>
</ul>

<p>We have also included all the other usual files (index.html, style.css, etc) and libraries (Bootstrap, D3, jQuery), like in our previous labs and homeworks.</p>

<h2 id="toc_6">Implementation</h2>

<p>The following image shows the visualization components of the system we are going to build. The core of the webpage and the main interaction point is <em>CountVis</em> (<code>countvis.js</code>). The area chart in the second row (<em>AgeVis</em>) gives an overview of the participants age and the bar chart shows the number of votes for each priority. If you consider this as a focus+context visualization, the <em>CountVis</em> component provides the context and the other two views display detailed information for the selected time frame.</p>

<p><img src="cs171-lab8-vis-components.png?raw=true" alt="Lab 8 - Components" title="Lab 8 - Components"></p>

<h3 id="toc_7">Data loading and pre-processing</h3>

<p>When you start to work on your final project or on other larger visualization systems you will probably find out that the data is not every time available in the desired format. Sometimes you have to transpose the data, aggregate values or combine datasets from multiple sources. In the course of the last weeks you have already learned how to handle most of it. In the following we want to introduce a new D3 technique that we have used in the <em>My World 2015</em> example and that helps you to extract/generate data.</p>

<p>We can use the <code>d3.range()</code> function to generate a range of numeric values:</p>

<pre><code class="language-javascript">var arithmeticProgression = d3.range(0,10)
arithmeticProgression    // Returns: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</code></pre>

<p>(The arguments specify the <em>start</em> and <em>end</em> of our sequence. If you start with 0 the second parameter is equal to the length of the array. You can test some examples in your web console.)</p>

<p>And we can use <code>map()</code> to execute a custom function for each value in a given array:</p>

<pre><code class="language-javascript">var result = arithmeticProgression.map(function(d){
    return d * 2;
});
result    // Returns: [0, 2, 4, 6, 8, 10, 12, 14, 16, 18]</code></pre>

<p>Finally, the combination of these methods allows us to generate arrays with custom values:</p>

<pre><code class="language-javascript">var twelveZeros = d3.range(0,12).map(function(){
    return 0;
});
twelveZeros     // Returns: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]</code></pre>

<p>Or to transform data that is stored in key-value format to arrays:</p>

<pre><code class="language-javascript">var d = {
    &quot;sum-0&quot;: 10,
    &quot;sum-1&quot;: 20,
    &quot;sum-2&quot;: 30,
    &quot;sum-3&quot;: 40
}

var result = d3.range(0,4).map(function(counter){
    return d[&quot;sum-&quot; + counter];
});

result      // Returns: [10, 20, 30, 40]</code></pre>

<hr>

<h4 id="toc_8">Activity I - Load the template and complete the charts</h4>

<ol>
<li><p><strong>Download the template</strong></p>

<p><a href="http://www.cs171.org/2016/assets/scripts/lab8/template.zip">http://www.cs171.org/2016/assets/scripts/lab8/template.zip</a></p></li>
<li><p><strong>Open the file <code>main.js</code> and get an overview of the data loading and cleaning procedure</strong></p>

<p>At the beginning of the file we have used <em>queue.js</em> to load the two datasets asynchronously.</p>

<p>If you have a look at the function <code>createVis()</code> you will recognize the mentioned technique <code>d3.range(n).map()</code>. We use it to clean the main dataset <code>perDayData.json</code> and to prepare it for the use in the visualization objects.</p>

<p>The basic implementation of the CountVis object is completed too. You should aready know how to draw an are chart in D3. If you open <code>index.html</code> in your webbrowser you should see the graph showing the number of votes for a specific time period.</p></li>
<li><p><strong>Implement the <em>AgeVis</em> component</strong></p>

<p>The second area chart visualizes the number of votes per age. We have also provided many code snippets in the file <code>agevis.js</code> but one further step is required.</p>

<p>The dataset <code>perDayData.json</code> currently groups all votes per day and age, but for this view we have to aggregate the values for each age group without the temporal information.</p>

<p><em>Example:</em></p>

<pre><code class="language-javascript">// Raw data
var days = [
    { &quot;date&quot;: &quot;2017-08-07&quot;, &quot;cat-0&quot;: 1, &quot;cat-1&quot;: 4, &quot;cat-2&quot;: 3 },
    { &quot;date&quot;: &quot;2017-08-08&quot;, &quot;cat-0&quot;: 2, &quot;cat-1&quot;: 0, &quot;cat-2&quot;: 1 },
    { &quot;date&quot;: &quot;2017-08-09&quot;, &quot;cat-0&quot;: 7, &quot;cat-1&quot;: 11, &quot;cat-2&quot;: 1 }
];

// Prepare empty array
var countPerCategory = d3.range(0,3).map(function() {
    return 0;
});

// Iterate over each day and fill array
days.forEach(function(day){
  d3.range(0,3).forEach(function(i){
        countPerCategory[i] += day[&quot;cat-&quot; + i];
  });
});

countPerCategory    // Returns: [10, 15, 5]</code></pre>

<p>→ Adopt this code snippet for the aggregation of votes, following our visualization pipeline, in the <code>wrangleData()</code> function. The My World 2015 project collects votes for all ages &lt;= 99. You can use the web console in between to debug your code and to better understand the data transformation. </p>

<p>→ Create an instance of the AgeVis component in <code>main.js</code></p>

<p>→ Open the webpage in your browser! If everything worked, you should see both area charts. If you get an error message in the web console you should fix it before going further.</p></li>
<li><p><strong>Implement the <em>PrioVis</em> component</strong></p>

<p>The bar chart (<code>priovis.js</code>) shows how many people voted (y-axis) for which of the 15 priorities (x-axis). Similar to the <em>AgeVis</em> component, the data is grouped by day and you have to aggregate it first.</p>

<p>→ Accumulate the votes for each priority in the <code>wrangleData()</code> function (basically the same procedure as before)</p>

<p>→ Create an instance of the PrioVis component in <code>main.js</code></p>

<p>→ Open the webpage in your browser and check if all three charts are visible</p></li>
<li><p><strong>Update the x-axis of the bar chart</strong></p>

<p>If you have finished all the previous steps, the user can see a bar chart with the number of votes for each priority on your webpage. Unfortunately, the numbers 0-14 have little meaning to the user and it would be helpful if you could display the names of the priorities on the x-axis instead.</p>

<p>You can modify the axis text after calling the axis component, like in this example, where we add the string &quot;Cat-&quot; as a prefix for every y-axis label:</p>

<pre><code class="language-javascript">svg.select(&quot;.y-axis&quot;)
        .call(yAxis)
    .selectAll(&quot;text&quot;)  
        .text(function(d){
            return &quot;Cat-&quot; + d;
        });</code></pre>

<p>(Alternatively, you can use D3&#39;s <code>tickFormat</code> function)</p>

<p>→ Access the values from the dataset <em>metaData</em> and display the full title for each priority. We already included the second dataset in the object constructor function and, due to the length of the titles, we rotated all x-axis labels by 45 degrees.</p></li>
</ol>

<hr>

<h3 id="toc_9">Event handling</h3>

<p>At the moment, the views display votes for the full time period (whole dataset) and they are not linked to each other.</p>

<p>Similar to lab 6 we will use <em>brushing</em> to enable the user to select a specific time frame and to filter the votes by time. <em>CountVis</em> is the main interaction point and the other two charts are getting updated accordingly.</p>

<p>To connect the three views we will make use of an event handler. Instead of being directly connected with each other, the views talk to each other via a mediator. A popular analogy of this principle is the Twitter service. For example, Homer follows (binds himself to) Bart. Once he has done that, Homer will be notified every time Bart tweets (triggers a message event), Homer and all other followers get notified. However, Bart is only notified of Homer&#39;s tweets when he also explicitly subscribes to Homer. Applied to our visualizations that can be imagined as:</p>

<p><img src="cs171-lab8-event-handler.png?raw=true" alt="Lab 8 - Event Hanlder" title="Lab 8 - Event Handler"></p>

<h4 id="toc_10">Brushing (review)</h4>

<p>In D3, a brush is an interactive area where clicking and dragging on the mouse is interpreted as a selection of a range (called <em>extent</em>). The range selection can be used to make changes to the visualization. The extent of the selection is shown as illustrated in the following image. Note that the area where you can click and drag to initiate a brush is shown in blue, while the visible representation of the brush is shown in grey.</p>

<p><img src="cs171-lab8-brush-region.png" width="300"></p>

<p>The D3 brush is comparable to D3&#39;s axis component. You have to initialize the brush and assign a scale, which (most of the time) is the same scale function that is already used for the x-axis.</p>

<p>The property <strong><code>on</code></strong> must be used to set an event listener, whereby you can choose between three different events:</p>

<ul>
<li><code>brushstart</code> - on mousedown</li>
<li><code>brush</code> - on mousemove, if the brush extent has changed</li>
<li><code>brushend</code> - on mouseup</li>
</ul>

<pre><code class="language-javascript">// Initialize time scale (x-axis)
var x = d3.time.scale()
    .range([0, width])
    .domain(d3.extent(displayData, function(d) { return d.Year; }));

// Initialize brush
var brush = d3.svg.brush()
    .x(x)
    .on(&quot;brush&quot;, brushed);

// Append brush
svg.append(&quot;g&quot;)
    .attr(&quot;class&quot;, &quot;brush&quot;);

// Call brush
svg.select(&quot;.brush&quot;).call(brush)
  .selectAll(&#39;rect&#39;)
    .attr(&quot;height&quot;, height);</code></pre>

<p>We also have to define some CSS rules:</p>

<pre><code class="language-css">.brush {
    fill: #ccc;
    fill-opacity: .5;
    pointer-events: none;
}</code></pre>

<p>Up to know we have always created a global function <code>brushed()</code> in the <code>main.js</code> file that was triggered every time when the brush region changed. In this file we can access and update all the other views. Although this solution is easy to understand and can be implemented quickly, it is not ideal for larger visualization systems. In this lab we will interchange it with an event handler.</p>

<h4 id="toc_11">Event handler</h4>

<p>We will make use of the event handling capabilities of <em>jQuery</em> and we are especially interested in these two functions:</p>

<ul>
<li><code>.bind(eventType, handler)</code> - binds a function handler to an event <code>eventType</code>, with handler being a javascript function and eventType being a specific string, e.g., &quot;bartTweeted&quot;.</li>
<li><code>.trigger(eventType, extraParameters)</code> - triggers an event <code>eventType</code> and calls all functions that are bound to this event. Here, eventType is a string (see above) and extraParameter is an object representing extra data, like e.g., the number of donuts homer ate per type of donut: <code>{&quot;message&quot;: &quot;A BURP IS NOT AN ANSWER, DONUTS ARE!&quot;, &quot;num_donuts&quot;&quot;: &quot;5&quot;, &quot;timestamp&quot;: &quot;Oct-10-2014, 10:00:12 PM GMT-5&quot;}</code></li>
</ul>

<p>The event handler must be initialized in the controller (<code>main.js</code>). We have prepared a small example for a better understanding:</p>

<pre><code class="language-javascript">// 1. Create event handler
var MyEventHandler = {};

// 2. Create visualization instances
var contextVis = new ContextVis(&quot;context-vis&quot;, data, MyEventHandler);
var focusVis = new FocusVis(&quot;focus-vis&quot;, data);</code></pre>

<p>In the brushing component (<code>contextvis.js</code>) we can listen to changes and trigger the event handler accordingly:</p>

<pre><code class="language-javascript">brush = d3.svg.brush()
    .x(x)
    .on(&quot;brush&quot;, function(){
        if(brush.empty()) {
            // No region selected (brush inactive)
            $(myEventHandler).trigger(&quot;selectionChanged&quot;, x.domain());
        } else {
            // User selected specific region
            $(myEventHandler).trigger(&quot;selectionChanged&quot;, brush.extent());
        }
    });</code></pre>

<p>And back in the controller we can bind our event handler to other visualization components:</p>

<pre><code class="language-javascript">// 3. Bind event handler
$(MyEventHandler).bind(&quot;selectionChanged&quot;, function(event, rangeStart, rangeEnd){
    focusVis.onSelectionChange(rangeStart, rangeEnd);
});</code></pre>

<p>In the final step we just have to filter the data and update the visualization component (<code>focusvis.js</code>):</p>

<pre><code class="language-javascript">FocusVis.prototype.onSelectionChange = function(selectionStart, selectionEnd){
    var vis = this;

    // vis.filteredData = vis.data.filter(function(d){
    // ...

    vis.wrangleData();
}</code></pre>

<hr>

<h4 id="toc_12">Activity II - Implement <em>brushing</em> and an <em>event handling</em> mechanism</h4>

<ol>
<li><p><strong>Initialize the <em>brush</em> component, append it to your SVG area and call it</strong> (<code>countvis.js</code>) </p>

<p>If you give your brush (group element) the class name &quot;brush&quot; you can use the predefined CSS rules.</p></li>
<li><p><strong>Initialize the event handler and pass it to the <em>CountVis</em> object</strong></p></li>
<li><p><strong>Trigger the event handler whenever the user changes the brush region</strong></p></li>
<li><p><strong>Bind the event handler to the <em>AgeVis</em> and <em>PrioVis</em> component</strong></p></li>
<li><p><strong>Implement the <em>onSelectionChange()</em> functions in</strong><code>agevis.js</code> <strong>and</strong> <code>priovis.js</code></p>

<p>These functions get called when the user changes the brush selection. You should filter the dataset (new start and end date) and update the visual elements in the SVG areas. Keep in mind that you need to store the original, unfiltered dataset.</p>

<p>Open the webpage in your browser. You should be able to select a brush region in the context visualization and the other two visualizations should be updated automatically.</p></li>
<li><p><strong>Show the selected time period</strong></p>

<p>→ Create additional elements in the <code>index.html</code> file to display the current time period. At the beginning it should cover the whole dataset and after the user changes the selection (brush) the dates should be updated immediately.</p>

<p>You can implement the function to update these text labels as part of the <em>CountVis</em> object. Similar to <em>AgeVis</em> or <em>PrioVis</em> in a new function, e.g. <code>onSelectionChange()</code>.</p>

<p><em>Example how it can look like:</em></p>

<p><img src="cs171-lab8-time-period.gif?raw=true" alt="Lab 8 - Time Period" title="Lab 8 - Time Period"></p></li>
</ol>

<hr>

<h3 id="toc_13">D3 Zoom Behavior</h3>

<p>Besides many drawing functionalities, the D3 library allows us to include interaction mechanisms into our visualizations. We can create event listeners for clicks and mouse gestures in order to improve the usability and to keep users engaged. In the previous examples we have used input fields and select-boxes to filter our datasets, we have implemented functions to change the sorting of SVG elements and most recently we have integrated D3&#39;s brushing component to select specific regions visually. Now we will introduce another interaction mechanism in D3 - the zoom behavior.</p>

<p>Panning &amp; zooming in visualizations allows users to move in and narrow down on the visible data points or to move out and to get a broader view of the data. The focus+context visualization, that you have implemented in lab 6, was basically also a certain type of zooming behavior, with the difference that we haved used an additional chart for the interaction. However, in many scenarios it is useful to zoom in directly (scroll on zoom) on the x-axis, y-axis or on both simultaneously.</p>

<p><em>Example:</em></p>

<pre><code class="language-javascript">// Initialize the zoom component
var zoom = d3.behavior.zoom()
    
    // Subsequently, you can listen to all zooming events
    .on(&quot;zoom&quot;, function(){
        // Do something
    })
    
    // Specify the zoom scale&#39;s allowed range
    .scaleExtent([1,20]);

// Specifiy an x-scale for the zoom
// The domain gets automatically adjusted when zooming
zoom.x(x);</code></pre>

<p>Similiar to axes or the brush component you have to apply the behavior to selected elements using <code>selection.call()</code>. Usually  you would draw an invisible rectangle over the full height and width of the visualization and bind the zoom behavior to it. But if you are additionally using the brush component you should apply it directly to it:</p>

<pre><code class="language-javascript">var brushGroup = svg.select(&quot;.brush&quot;)
brushGroup.call(zoom);</code></pre>

<p>Further details:</p>

<ul>
<li>The D3 zoom component actually consists of the zoom and pan behavior. The panning behavior, that makes you able to pan along the x and y axis, is needed when you want to zoom in to a specific point</li>
<li>You can also define an y-scale for the zoom</li>
<li>If you don&#39;t specify the attribute <code>scaleExtent()</code>, the zoom component will default to [0, <em>Infinity</em>].</li>
</ul>

<p>You can read more about D3&#39;s zooming component here: <a href="https://github.com/d3/d3-3.x-api-reference/blob/master/Zoom-Behavior.md">https://github.com/d3/d3-3.x-api-reference/blob/master/Zoom-Behavior.md</a></p>

<hr>

<h4 id="toc_14">Activity III - Make the <em>CountVis</em> component zoomable along the x-axis</h4>

<p><em>Preview:</em></p>

<p><img src="cs171-lab8-zoom.gif?raw=true" alt="Lab 8 - Zoom" title="Lab 8 - Zoom"></p>

<ol>
<li><p><strong>Initialize the D3 zoom behavior</strong></p>

<p>→ Register the &quot;zoom&quot; event listener and call the <code>updateVis()</code> function every time the users zooms in or out. You should check if the brush component is active (user selected a specific time frame) and update <code>brush.extent()</code> before calling the update function. Otherwise the user zooms on the x-axis and the brush window remains unchanged.</p>

<pre><code class="language-javascript">if (vis.currentBrushRegion)
    vis.brush.extent(vis.currentBrushRegion);</code></pre>

<p>→ Define a zoom extent: 1-20</p></li>
<li><p><strong>Bind the zoom behavior to the x-axis</strong></p></li>
<li><p><strong>Call the <em>brush</em> and <em>zoom</em> components in the</strong> <code>updateVis()</code> <strong>function</strong></p>

<p>Due to the use of <em>brushing</em> we have to deal with a special case. We already use the clicking and dragging events for specifying the size of the brush window. Therefore we can&#39;t use panning and we have to block these events in the zoom component:</p>

<pre><code class="language-javascript">selection.call(zoom)
    .on(&quot;mousedown.zoom&quot;, null)
    .on(&quot;touchstart.zoom&quot;, null);</code></pre>

<p>For testing you can omit this and open the webpage in your browser. You will notice the <em>bumpy</em> interaction.</p></li>
<li><p><strong>Clip all elements that go beyond the borders of your chart area</strong></p>

<p>At the moment we don&#39;t filter our data while zooming and we also don&#39;t draw a different path. We are just modifying the domain of our x-axis and determine thereby which part is visible and which not. This means that parts of our elements (path or brush rectangle) overlap others and go beyond the borders.</p>

<p>To avoid this, you have to clip the elements:</p>

<pre><code class="language-javascript">// Define the clipping region
svg.append(&quot;defs&quot;).append(&quot;clipPath&quot;)
    .attr(&quot;id&quot;, &quot;clip&quot;)
  .append(&quot;rect&quot;)
    .attr(&quot;width&quot;, width)
    .attr(&quot;height&quot;, height);

// And apply it to the path, brush and all other elements you want to clip
areaPath
    .datum(data)
    .attr(&quot;d&quot;, area)
    .attr(&quot;clip-path&quot;, &quot;url(#clip)&quot;);</code></pre></li>
</ol>

<hr>

<h4 id="toc_15">Bonus Activity (optional) - Implement a button to reset the zoom</h4>

<p>Due to the use of <em>brushing</em> and <em>zooming</em> in one view we can&#39;t use the panning behavior. It may happen that the user zooms in and out and the x-axis gets shifted in one direction. The user can&#39;t see the full path and has to reposition the mouse multiple times (while zooming) to return to the starting point. With panning, for example, we could move the camera/viewport from left to right.</p>

<p>To solve this problem you can also create a button to reset the view.</p>

<p>→ Add a reset-button to your HTML file</p>

<p>→ Listen to &quot;clicks&quot; on the button and reset the zoom (scale = 1)</p>

<p>→ Show the button only if zooming is active or if the x-axis has been shifted</p>

<p><em>Great job, you have implemented a more complex visualization system with multiple visualization types, event handlers and state-of-the-art interaction techniques!</em></p>

<hr>

<h4 id="toc_16">Submission of 1-minute paper</h4>

<p>Congratulations, you have now completed the activities of Lab 8! Please submit your 1-minute paper now!</p>

<p><em>See you next week!</em></p>

<hr>

<h4 id="toc_17">Submission of lab (activity I - III and optionally the bonus task)</h4>

<p>Please upload the code of your completed lab (the final interactive webpage) on Vocareum! </p>

<hr>

<p>&nbsp;</p>

<p><strong>Resources</strong></p>

<ul>
<li><a href="https://github.com/d3/d3-3.x-api-reference/blob/master/Zoom-Behavior.md">https://github.com/d3/d3-3.x-api-reference/blob/master/Zoom-Behavior.md</a></li>
<li><a href="https://www.dashingd3js.com/lessons/d3-zoom-behavior-part-two">https://www.dashingd3js.com/lessons/d3-zoom-behavior-part-two</a></li>
</ul>


</body>

</html>
