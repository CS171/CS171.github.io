<!DOCTYPE html><html>

<head>
<meta charset="utf-8">
<title>README</title>
<style type="text/css">
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>
</head>
<body>
<p><img src="cs171-logo.png" width="200"></p>

<p>&nbsp;</p>

<h1 id="toc_0">Lab 7</h1>

<h3 id="toc_1">Learning Objectives</h3>

<ul>
<li>Know how to <em>link</em> multiple views with each other</li>
<li>Understand the concept behind D3&rsquo;s brush component</li>
<li>Understand the JS keyword <em>this</em> and the scope of execution</li>
<li>Get a better understanding of <em>system design</em> and <em>code structure</em></li>
</ul>

<h3 id="toc_2">Prerequisites</h3>

<ul>
<li>You have read and <strong>programmed</strong> along with:

<ul>
<li><a href="http://www.cs171.org/2016/assets/material/cs171-lab7-reading.pdf">http://www.cs171.org/2016/assets/material/cs171-lab7-reading.pdf</a></li>
<li>The four chapters about JS objects at <a href="http://www.w3schools.com/js/js_object_definition.asp">http://www.w3schools.com/js/js<em>object</em>definition.asp</a> (repetition of JS objects with more examples)</li>
<li><em>[Optional]</em> <a href="https://software.intel.com/en-us/xdk/blog/javascript-this-that-and-the-other-thing">Scope and <em>this</em> in JavaScript</a></li>
</ul></li>
<li>You have successfully filled in the pre-quiz for the 7th lab.</li>
</ul>

<p>In the last weeks you have learned the fundamentals of the JS library D3 and you have gained some implementation expertise during previous labs and homeworks. You should be comfortable with the major concepts and be able to implement common charts as well as interactive and more advanced visualizations with D3.</p>

<p>In this lab you will work on a new problem set. It is continuous, a bit longer than the usual activities, and it will give you a better understanding of <em>linked views</em> and <em>system design</em>.</p>

<p>We will provide a template and many additional code snippets so that your main tasks will focus on the structure and the event handling components. However, please make sure that you understand the code in the provided templates, and take your time to read through it!</p>

<h2 id="toc_3">Data</h2>

<p><strong>Purchases for Household Supplies in the UK</strong></p>

<p>In this lab you will work with a dataset that contains detailed annual statistics on family food and drink purchases in the UK.</p>

<p>We have already extracted the major information and created a JSON file with data between 1974 and 2013.</p>

<p>The JSON file is divided into two major arrays with objects: </p>

<ul>
<li><code>years</code> contain the average weekly spending on food and drinks in pence (GBX) per person</li>
<li><code>layers</code> also contain the average weekly spending, but separated into 21 different <em>food</em> categories</li>
</ul>

<p><em>JSON Structure:</em></p>

<pre><code class="language-javascript">{
    &quot;years&quot;: [
        { &quot;Year&quot;: 1974, &quot;Expenditures&quot;: 331.437 },
        ...
        { &quot;Year&quot;: 2013, &quot;Expenditures&quot;: 2986.373 }
    ],
    &quot;layers&quot;: [
        {
            &quot;Year&quot;: 1974,
            &quot;Milk and milk products excluding cheese&quot;: 29.228,
            &quot;Cheese&quot;: 8.694,
            &quot;Carcase meat&quot;: 44.479,
            &quot;Non-carcase meat and meat products&quot;: 55.915,
            &quot;Fish&quot;: 13.652,
            &quot;Eggs&quot;: 11.429,
            &quot;Fats&quot;: 14.537,
            ....
        },
        {
            &quot;Year&quot;: 1975,
            &quot;Milk and milk products excluding cheese&quot;: 37.239,
            &quot;Cheese&quot;: 10.377,
            ...
        },
        ...
    ]
}
</code></pre>

<p>The data is part of the annual <em>Family Food Report</em>, it is published through UK&rsquo;s open government platform <em>gov.uk</em> and is updated every year. However, the dataset is not completely accurate and there is a lack of data in some areas. For example, alcoholic and soft drink figures appear for the first time in 1992, but we can assume that people have consumed these products before.</p>

<p><em>Source: <a href="https://www.gov.uk/government/statistical-data-sets/family-food-datasets">https://www.gov.uk/government/statistical-data-sets/family-food-datasets</a></em></p>

<h2 id="toc_4">Template</h2>

<p>This lab will bring you a step closer to implementing more complex visualizations which makes it necessary to adapt the way how we organize our application. However, the provided template is quite similar to previous labs and homeworks. It is based on Bootstrap and it contains a basic HTML structure, some CSS rules and pieces of JS code.</p>

<p>During this lab we will introduce a concept which will help you to structure a D3 project with multiple visualizations. For this reason, we will also describe the file structure in more detail. The main change is that each visualization is a separate JS object and the implementation of the different visualizations is moved into separate JS files.</p>

<h2 id="toc_5">Preview</h2>

<p><em>After implementing all tasks your visualization should look like this:</em></p>

<p><img src="cs171-lab7-preview.gif?raw=true" alt="Lab 7 - Preview" title="Lab 7 - Preview"></p>

<h2 id="toc_6">Conceptual and technical background</h2>

<p>Thinking about the structure of your project early on can save you a lot of time and will make your implementation more robust, extensible and reusable.</p>

<h3 id="toc_7">Files and folders</h3>

<p><em>The provided template is structured as follows:</em></p>

<ul>
<li><strong>index.html</strong> is the default file that appears when a user invokes your webpage. It should include a basic structure and placeholders for your visualizations. </li>
<li><strong>/js</strong> contains the JS files for the visualization and external libraries (can be further sub-divided)</li>
<li><strong>/data</strong> contains the data files</li>
<li><strong>/css</strong> contains the stylesheet files</li>
</ul>

<h3 id="toc_8">Divide and conquer</h3>

<p>You should always try to split a complex problem into smaller, easier-to-tackle sub-problems. Each sub-problem will be solved independently and afterwards integrated into the final system.</p>

<p><strong>Visualizations should be organized and structured into individual code components</strong> and, if possible, implemented as flexible and reusable components. Therefore, we will organize each visualization as an object.</p>

<p>The visualization specific implementation should be done in object functions and should follow this pipeline:</p>

<p><img src="cs171-vis-object.png?raw=true" alt="Vis object" title="Vis Object"></p>

<h3 id="toc_9">Visualizations as objects</h3>

<p><em>The following example will give you a better understanding of these steps.</em></p>

<p>We can create an instance of an object by using the keyword <code>new</code>. The object constructor should be used to define properties:</p>

<pre><code class="language-javascript">// Create an object instance
var barchart = new BarChart(&quot;bar-chart-container&quot;, data);</code></pre>

<p>We can define properties within an object by using the keyword <code>this</code>:</p>

<pre><code class="language-javascript">// Object constructor function
BarChart = function(_parentElement, _data){
    this.parentElement = _parentElement;
    this.data = _data;

    // Call an object function
    this.initVis();
}</code></pre>

<p>We will implement methods as <code>Object.prototype</code> properties:</p>

<pre><code class="language-javascript">BarChart.prototype.initVis = function(){
    ...
}</code></pre>

<blockquote>
<p><strong>Object.prototype</strong></p>

<ul>
<li>All JavaScript objects inherit their properties and methods from their <em>prototype</em></li>
<li>The methods are in the execution context of the object</li>
<li>The object property <code>prototype</code> allows you to add new properties/methods to an existing prototype</li>
</ul>
</blockquote>

<p>The variables should be stored in the visualization object by using the <code>this</code> keyword. We would recommend to create another variable (for example <code>vis</code> or <code>_this</code>) to store the <em>this</em>-accessor. Otherwise the scope of <code>this</code> will change and it will cause undesirable side-effects:</p>

<pre><code class="language-javascript">BarChart.prototype.initVis = function(){
    var vis = this;
    
    vis.margin = { top: 20, right: 0, bottom: 60, left: 60 };

    vis.width = 800 - vis.margin.left - vis.margin.right,
    vis.height = 400 - vis.margin.top - vis.margin.bottom;
  
    vis.svg = d3.select(&quot;#&quot; + vis.parentElement).append(&quot;svg&quot;)
        .attr(&quot;width&quot;, vis.width + vis.margin.left + vis.margin.right)
        ...
}</code></pre>

<p>At the end of <code>initVis()</code> we call the function <code>wrangleData()</code> to follow our implementation pipeline:</p>

<pre><code class="language-javascript">BarChart.prototype.initVis = function(){
    ...
    
    vis.wrangleData();
}</code></pre>

<p>It is quite usual that you have to process and prepare data (filter, aggregate, &hellip;) for a visualization whenever the data changes or after a user interaction. The function <code>wrangleData()</code> should take the raw data and modify it in a way that it can be mapped to the screen afterwards (<code>updateVis()</code>):</p>

<pre><code class="language-javascript">BarChart.prototype.wrangleData = function(){
    var vis = this;

    // Filter example
    vis.displayData = vis.data.filter(function(d){
        return d.year &gt; 2000;
    });
    
    // Draw visualization
    vis.updateVis();
}</code></pre>

<p>You should already be familiar with the last part. The function <code>updateVis()</code> contains the D3 update pattern (<em>enter, update, exit</em>). We use the variable <code>displayData</code> that we have created in <code>wrangleData()</code> before:</p>

<pre><code class="language-javascript">BarChart.prototype.updateVis = function(){
    var vis = this;

    // Update domains
    vis.y.domain([0, d3.max(vis.displayData, function(d) { return d.price; })]);
    ...
    
    // Draw the actual bar chart
    var bar = svg.selectAll(&quot;.bar&quot;)
      .data(data);
  
    bar.enter().append(&quot;rect&quot;)
        .attr(&quot;class&quot;, &quot;bar&quot;)
        ...
}
</code></pre>

<h3 id="toc_10">Project overview</h3>

<p>The previous example showed the implementation of a bar chart in an object-oriented way. To follow the main divide-and-conquer concept (i.e., splitting up a complex problem into various sub-tasks) we should also apply this to the file structure of our project.</p>

<p><img src="cs171-lab7-overview.png?raw=true" alt="Project Overview" title="Project Overview"></p>

<p>We separate the visualization specific code into external files and create object instances in the file <code>main.js</code>, which is the entry point of our application. For example, if we want to use the same data for multiple charts we have to load the data only once in <em>main.js</em>. Thereby, our code stays clean and understandable. </p>

<p>This methodology will become very helpful for developing larger systems and more sophisticated interaction mechanisms.</p>

<h3 id="toc_11">Implementation</h3>

<h4 id="toc_12">Activity I - Load data and create an instance of the stacked area chart</h4>

<p>For all implementation parts in this lab, you should keep in mind that visualizations are implemented as objects. So if you want to store variables that belong to the visualization, make sure that you store it in the correct context (e.g., <code>vis.my_variable</code>). The same goes for accessing object parameters. If you get an error that a variable is undefined, make sure that you access it correctly! </p>

<p>For simplicity reasons, in the example code below, we have not always included the object oriented way of accessing variables - you will have to adjust that code to your overall code structure.</p>

<ol>
<li><p><strong>Download the template</strong></p>

<p><a href="http://www.cs171.org/2016/assets/scripts/lab7/template.zip">http://www.cs171.org/2016/assets/scripts/lab7/template.zip</a></p>

<p>Check the <code>index.html</code> file and get a quick overview of the template.</p>

<ul>
<li>The file <code>js/main.js</code> is the entry point of our application. It contains general scripts (e.g., loading the data) and it should create instances of the visualizations</li>
<li>The file <code>js/stackedAreaChart.js</code> contains the specific implementation of the stacked area chart (see bar chart example above)</li>
</ul>

<p>The data loading script is already complete and we have also created the file <em>stackedAreaChart.js</em> with boilerplate code.</p></li>
<li><p><strong>Create an instance of <code>StackedAreaChart</code></strong></p>

<p>After the data is loaded completely, the function <code>createVis()</code> in <em>main.js</em> is getting called. We will use this function to create instances of the visualizations.</p>

<p>→ Create an instance of <code>StackedAreaChart</code> and use the constructor to specify the properties: <strong><em>parentElement</em></strong> (&ldquo;stacked-area-chart&rdquo;) and <strong><em>data</em></strong> (&ldquo;allData.layers&rdquo;).</p>

<p>→ Open the webpage in your browser! If everything worked, you should see the loaded data in the web console and an SVG area with placeholders for the axes in the web inspector. If you get an error message in the web console you should fix it before going further.</p></li>
</ol>

<hr>

<h3 id="toc_13">Stack Layout</h3>

<p>As you have seen in the preview at the beginning of this lab, you have to create a stacked area chart to visualize the different categories of UK&rsquo;s household expenditures. Instead of calculating the coordinates of these layers manually you can use the <em>d3.layout.stack()</em> to generate a baseline value for each datum, so you can &ldquo;stack&rdquo; layers of data on top of each other.</p>

<p>And as a reminder from the previous lab: <em>The D3 layout methods have no direct visual output. They take data that you provide and re-map or otherwise transform it, thereby generating new data that is more convenient for a specific task.</em></p>

<p><em>Example:</em></p>

<pre><code class="language-javascript">// Example data
var data = [
    {
        &quot;name&quot;: &quot;Milk&quot;,
        &quot;values&quot;: [
            { &quot;Year&quot;: 2015, &quot;y&quot;: 10 },
            { &quot;Year&quot;: 2016, &quot;y&quot;: 12 },
            { &quot;Year&quot;: 2017, &quot;y&quot;: 11 }
        ]
    },
    {
        &quot;name&quot;: &quot;Water&quot;,
        &quot;values&quot;: [
            { &quot;Year&quot;: 2015, &quot;y&quot;: 4 },
            { &quot;Year&quot;: 2016, &quot;y&quot;: 6 },
            { &quot;Year&quot;: 2017, &quot;y&quot;: 7 }
        ]
    }
];

// Initialize layout function
// with the &#39;values&#39; accessor due to the multi-dimensional array
var stack = d3.layout.stack()
    .values(function(d) { return d.values; });

// Call layout function on the dataset
stack(data);

console.log(data);</code></pre>

<p><em>Result:</em></p>

<p><img src="cs171-stacked-data.png?raw=true" alt="Stacked Data" title="Stacked Data"></p>

<p>In the stacked data, each object has been given a y0 value. This is the <em>baseline</em> value. Notice that the y0 baseline value is equal to the sum of all the y values in the preceding categories. The category <em>&ldquo;Milk&rdquo;</em> is our first category and starts at the bottom, which means that the y0 values are zero.</p>

<h3 id="toc_14">Stacked Area</h3>

<p>To stack these categories visually, we can create <em>stacked bar charts</em> or <em>stacked area charts</em>. In this lab you will create a stacked area chart. But it should be easy to adopt the workflow to a bar chart.</p>

<p>You have already created an area chart (see <em>HW4 - Za&#39;atari Refugee Camp</em>) and a line chart (see <em>HW5 - FIFA World Cup</em>) and you should know how to use the D3 path generator. The built-in <code>d3.svg.area()</code> is ideally suited for the stacked area chart too. It just needs some slight modifications of the <code>y0()</code> and <code>y1()</code> parameters to consider the different baselines:</p>

<pre><code class="language-javascript">// Basic: area
var area = d3.svg.area()
    .interpolate(&quot;cardinal&quot;)
    .x(function(d) { return x(d.Year); })
    .y0(height)
    .y1(function(d) { return y(d.y); });

// Extended: stacked area
var area = d3.svg.area()
    .interpolate(&quot;cardinal&quot;)
    .x(function(d) { return x(d.Year); })
    .y0(function(d) { return y(d.y0); })
    .y1(function(d) { return y(d.y0 + d.y); });</code></pre>

<p><em>The cardinal interpolation is optional and can be used to create smooth shapes.</em></p>

<hr>

<h4 id="toc_15">Activity II - Create a stacked area chart</h4>

<p><em>The file <code>stackedAreaChart.js</code> contains some functions with code snippets (append SVG, initialize scales and axes, etc). Try to get a quick overview and extend the implementation by running trough the following steps:</em></p>

<ol>
<li><p><strong>Stack the data</strong></p>

<p><em>This task should be done only once, so we would recommend an implementation in the <code>initVis()</code> function. If you want to filter the data, you can do this afterwards in the <code>wrangleData()</code> function directly on the &ldquo;stacked&rdquo; data.</em></p>

<p>D3 Wiki: <a href="https://github.com/mbostock/d3/wiki/Stack-Layout">https://github.com/mbostock/d3/wiki/Stack-Layout</a></p>

<p>It might seem pretty easy to &ldquo;stack&rdquo; the data with the built-in layout method <code>d3.layout.stack</code> (like in the example above) but for this to work, the raw data must be in a special format. You can compare the output in the web console with the <em>&ldquo;Milk and water&rdquo;</em>-example above and you will notice the difference.</p>

<p>Therefore, our first step is to transpose the loaded data and rearrange it in an array of arrays (do this directly after you init the D3 stack layout, but before you call the layout function on the dataset, all within <code>initVis()</code>):</p>

<ul>
<li><p><strong><em>Get all categories</em></strong></p>

<p>You can reuse <code>colorScale.domain()</code> to get all category names. In the file <em>main.js</em>, after the initial data preparation, we have used <em>d3.keys</em> to set the domain of the color scale. Take a look at that part in the code in <em>main.js</em> to make sure you understand what is going on, before getting the categories in <code>initVis()</code> as shown below.</p>

<pre><code class="language-javascript">var dataCategories = colorScale.domain();</code></pre></li>
<li><p><strong><em>Transpose the data</em></strong></p>

<p>Currently the dataset consists of JSON objects for each year with 21 food categories and the corresponding date. Now, you have to transpose the data into layers. Each layer contains a name and a <em>values</em> array with the category-specific data for each year.</p>

<pre><code class="language-javascript">// Required format
var data = [
    {
        &quot;name&quot;: &quot;Milk&quot;,
        &quot;values&quot;: [
            { &quot;Year&quot;: 2015, &quot;y&quot;: 10 },
            { &quot;Year&quot;: 2016, &quot;y&quot;: 12 }
        ]
    },
    {
        &quot;name&quot;: &quot;Water&quot;,
    ...
];</code></pre>

<p>You can rearrange the data by using the array <em>map()</em> function and iterating over all categories:</p>

<pre><code class="language-javascript">// Rearrange data into layers
var transposedData = dataCategories.map(function(name) {
    return {
        name: name,
        values: vis.data.map(function(d) {
            return {Year: d.Year, y: d[name]};
        })
    };
});</code></pre></li>
</ul>

<p>We are providing you with a lot of code here that is quite complex on first sight. Make sure that you think through each step of the data pre-processing and use debug statements until you understand what each <code>map()</code> is doing! (You could also use a bunch of for loops to rearrange the data, but using <code>map()</code> is more efficient and easier to read.)</p>

<ul>
<li><p><strong><em>Stack the data</em></strong></p>

<p>After initializing a D3 stack layout you can call it on the dataset:</p>

<pre><code class="language-javascript">var stackedData = stack(transposedData);</code></pre></li>
</ul></li>
<li><p><strong>Initialize the D3 path generator in <code>initVis()</code></strong></p>

<p>After transforming the data into layers you have to initialize a path generator which maps the actual values to screen coordinates. The <code>updateVis()</code> function will use it later to draw the chart.</p>

<p><em>Make sure to save the path generator in the variable <code>area</code>:</em></p>

<pre><code class="language-javascript">vis.area = d3.svg.area() ...</code></pre></li>
<li><p><strong>Call the <code>wrangleData()</code> function and draw the chart</strong></p>

<p>This function will be used to filter/aggregate the dataset every time the visualization is rendered. Therefore, remove the comment and call <em>wrangleData()</em> at the end of the <em>initVis()</em> function. This will automatically call <em>updateVis()</em>. You will have to extend <em>wrangleData()</em> later.</p>

<p>We have already implemented a basic version of the <code>updateVis()</code> function for you. It will update the y-axis domain, create visual elements for the stacked layers by using your path generator and finally update the axis labels. </p>

<p>If you have completed the above implementation steps correctly, you should see the stacked area chart in your browser.</p>

<p><em>Otherwise, debug your code and make sure that the data preparation (stacked data) and the path generator (<code>vis.area</code>) is working as required.</em></p></li>
</ol>

<hr>

<h3 id="toc_16">Focus+Context via Brushing</h3>

<p>In the next task you will extend the visualization with a second chart (a basic area chart; see <em>Preview</em>), to give the user the possibility to zoom and to select a specific time range. </p>

<h4 id="toc_17">Focus+Context</h4>

<ul>
<li>The stacked area chart should show selected regions in greater detail (<em>focus</em>)</li>
<li>The basic area chart preserves a global view at reduced detail without layers (<em>context</em>)</li>
</ul>

<p><em>This technique allows us to show the user detailed information linked with an overview (context) simultaneously.</em></p>

<h4 id="toc_18">Brushing &amp; Linking</h4>

<p>The idea of <em>brushing</em> is to allow the user to select a subset of data interactively. In combination with <em>linking</em> - changes are automatically reflected in <em>linked</em> visualizations - you can get the desired focus+context visualization.</p>

<p><img src="cs171-focus-context.gif?raw=true" alt="Focus + Context" title="Focus + Context"></p>

<h4 id="toc_19">Brushing with D3</h4>

<p>D3 Wiki: <a href="https://github.com/mbostock/d3/wiki/SVG-Controls">https://github.com/mbostock/d3/wiki/SVG-Controls</a></p>

<p>The D3 brush is comparable to D3&rsquo;s axis component. You have to initialize the brush and assign a scale, which (most of the time) is the same scale function that is already used for the x-axis.</p>

<p>The property <strong><code>on</code></strong> must be used to set an event listener, whereby you can choose between three different events:</p>

<ul>
<li><code>brushstart</code> - on mousedown</li>
<li><code>brush</code> - on mousemove, if the brush extent has changed</li>
<li><code>brushend</code> - on mouseup</li>
</ul>

<pre><code class="language-javascript">// Initialize time scale (x-axis)
var xContext = d3.time.scale()
    .range([0, width])
    .domain(d3.extent(displayData, function(d) { return d.Year; }));

// Initialize brush component
var brush = d3.svg.brush()
    .x(xContext)
    .on(&quot;brush&quot;, brushed);</code></pre>

<p>We can react to the <em>event</em> and update the linked visualizations in a separate function. Particularly noteworthy is the property <code>brush.extent()</code> which returns the current brush extent or in other words, it returns the user&rsquo;s selection.</p>

<pre><code class="language-javascript">function brushed() {
    // Set new domain if brush (user selection) is not empty
    xFocus.domain(
        brush.empty() ? xContext.domain() : brush.extent()
    );
    
    // Update focus chart (detailed information)
    ...
}</code></pre>

<p>We have initialized the brush component and implemented an event listener. In the last step it is necessary to append the brush to the <em>context chart</em>. This step is also comparable to appending a D3 axis. An additional rectangle, within the SVG group element, should indicate the current selection for the user: </p>

<pre><code class="language-javascript">// Append brush component
svg.append(&quot;g&quot;)
      .attr(&quot;class&quot;, &quot;x brush&quot;)
      .call(brush)
    .selectAll(&quot;rect&quot;)
      .attr(&quot;y&quot;, -6)
      .attr(&quot;height&quot;, height + 7);</code></pre>

<hr>

<h4 id="toc_20">Activity III - Implement Focus+Context</h4>

<p><em>In the next activity you will have to implement a second chart with an interactive brushing component. Most of the parts are already complete but you have to connect the components to each other.</em></p>

<ol>
<li><p><strong>Create an instace of <code>Timeline</code></strong></p>

<p><em>The result of this lab should be a stacked area chart (focus) linked with a basic area chart (context). To avoid confusion, we will call the basic area chart from now on &ldquo;timeline&rdquo; because it shows the full time period.</em></p>

<p>You can find the implementation of the timeline in <code>js/timeline.js</code>. The self-contained component follows our methodology and can be easily integrated into the system.</p>

<p>→ Open <code>timeline.js</code> and get an overview of the implementation. It is much shorter than the stacked area chart because the area path and the axis is static and we don&rsquo;t need any data wrangling tasks.</p>

<p>→ Create an instance of <code>Timeline</code> and use the constructor to specify the properties (see <em>constructor function</em> in <code>timeline.js</code>). The timeline should not include the detailed layers of our data, but it should indicate the general trend. Therefore, the data <code>allData.years</code> is perfectly suited. </p>

<p>↻ Reload the webpage in your browser. If you have created the instance correctly you should see the timeline below your stacked area chart. Otherwise make sure that you have included the right parameters (container ID, data).</p></li>
<li><p><strong>Implement the brushing component</strong></p>

<p>You have to extend the timeline and implement the described focus+context approach for the visualization. The prior brushing example should help you to include the necessary pieces of code.</p>

<p>→ Initialize the brushing component in the <code>initVis()</code> function</p>

<p>→ Create a global function <code>brushed</code> in <em>main.js</em></p>

<ul>
<li><p>The implementation in this file acts as a controller and can access both charts. Alternatively, and more important for larger systems, you can include a more sophisticated event handling mechanism. But for this example it is enough to create a global function and link the two visualizations directly.</p></li>
<li><p>Update the x domain of the stacked area chart every time the <em>brushed</em> event gets triggered. And don&rsquo;t forget to update the chart by calling:</p>

<pre><code class="language-javascript">areachart.wrangleData();</code></pre></li>
</ul>

<p>→ Append the brush component to the <em>timeline</em> SVG </p>

<p>↻ Reload the webpage in your browser. You should be able to choose a specific time period in the timeline (context) and the stacked area chart (focus) will automatically zoom in and will show the details for the selected years.</p>

<p>But now there is probably an error in the stacked area chart. When you zoom in, the layers will expand and go beyond the y-axis until they reach the end of the SVG container. You should solve the problem by using a rectangle as an overlay and clipping the path:</p>

<p><em>Paste this code snippet after creating the SVG element:</em></p>

<pre><code class="language-javascript">vis.svg.append(&quot;defs&quot;).append(&quot;clipPath&quot;)
    .attr(&quot;id&quot;, &quot;clip&quot;)
  .append(&quot;rect&quot;)
    .attr(&quot;width&quot;, vis.width)
    .attr(&quot;height&quot;, vis.height);</code></pre></li>
</ol>

<hr>

<h4 id="toc_21">Activity IV - Implement basic tooltips</h4>

<p><em>Currently it is not possible to identify layers and to get detailed information for a specific year. All of this would require an advanced tooltip solution.</em></p>

<p>You will implement a lightweight version of these tooltips which should help the user to identify just the category names.</p>

<ol>
<li><p><strong>Append a tooltip placeholder</strong></p>

<p>Open <code>stackedAreaChart.js</code> and append an empty SVG text element. This element should be created only once. It should be used as a placeholder for the category names and should get updated every time the user hovers over a layer.</p>

<p>Feel free to choose proper coordinates. In the preview the label is positioned in the top left corner of the stacked area chart.</p></li>
<li><p><strong>Update the tooltip</strong></p>

<p>Create a mouse listener for the <em>SVG path</em> (layer of stacked area chart, in <code>updateVis()</code>) and update the <code>text</code> property of the tooltip-element every time the user hovers over it.</p></li>
</ol>

<hr>

<h4 id="toc_22">Bonus Activity (optional) - Show details for a specific layer</h4>

<p>Due to the stacked layout it is sometimes difficult to see the exact evolution of a specific layer. An extension which allows the user to click on a category in order to see the details would solve this problem.</p>

<p><img src="cs171-layer-details.gif?raw=true" alt="Layer Details" title="Layer Details"></p>

<p><em>You should implement:</em></p>

<ul>
<li>A variable <code>filter</code> that stores the current category (if nothing is selected, the <em>filter</em> variable should be empty)</li>
<li><p>A click listener for the layers (in addition to the previous mouse hover listener) that triggers the update of the stacked area chart. If the user clicks on the same category again the visualization should jump back to its default state.</p>

<p><em>Example for a click listener with toggle feature:</em></p>

<pre><code class="language-javascript">.on(&quot;click&quot;, function(d) {
    vis.filter = (vis.filter == d.name) ? &quot;&quot; : d.name;
    vis.wrangleData();
})</code></pre></li>
<li><p>A second path generator <em>d3.svg.area()</em> in <code>initVis()</code> for displaying a single layer. You can go to <em>timeline.js</em> to see the path generator for a basic SVG area. (Basically this whole feature you are implementing is just a switch between the stacked area chart and a basic area chart. )</p></li>
<li><p>An extension of the function <code>wrangleData()</code>. If the user selects a specific layer the <em>display data</em> should be filtered:</p>

<pre><code class="language-javascript">.filter(function(d) { return d.name == vis.filter } );</code></pre>

<p>Make sure you add an IF statment and update <code>vis.displayData</code> accordingly.</p></li>
<li><p>An extension of the &ldquo;domain update&rdquo; for the <strong><em>y-scale</em></strong> (in <code>updateVis()</code>. If you want to display a typical area chart without layers you have a fixed baseline at zero and don&rsquo;t need to consider the <em>y0</em> parameter..</p>

<pre><code class="language-javascript">if(vis.filter) {
    vis.y.domain([0, d3.max(vis.displayData[0].values,
            function(d) { return d.y; })]);
} else {
    ...
}</code></pre></li>
<li><p>An IF statement in the <em>update</em> section to switch between the simple path generator (area) and the advanced path generator (stacked area) depending on wether the user has selected a category (in <code>updateVis()</code>):</p>

<pre><code class="language-javascript">.attr(&quot;d&quot;, function(d) {
    if(vis.filter)
        return ...
    else
        return vis.area(d.values);
})</code></pre></li>
</ul>

<p>Great job, you now have a focus-and-context visualization that even allows you to get details on individually selected categories!</p>

<hr>

<h4 id="toc_23">Submission of 1-minute paper</h4>

<p>Congratulations, you have now completed the activities of Lab 7! Please submit your 1-minute paper now!</p>

<p><em>See you next week!</em></p>

<hr>

<h4 id="toc_24">Submission of lab (activity I - IV)</h4>

<p>Please upload the code of your completed lab (the final focus-and-context visualization you created in activities I-IV) on Vocareum! </p>

<hr>

<p>&nbsp;</p>

<p><strong>Resources</strong></p>

<ul>
<li>p. 206-209 in <em>D3 - Interactive Data Visualization for the Web</em> by Scott Murray</li>
<li><a href="http://javascriptplayground.com/blog/2012/04/javascript-variable-scope-this/">http://javascriptplayground.com/blog/2012/04/javascript-variable-scope-this/</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Introduction_to_Object-Oriented_JavaScript">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Introduction<em>to</em>Object-Oriented_JavaScript</a></li>
<li><a href="http://www.w3schools.com/js/default.asp">http://www.w3schools.com/js/default.asp</a></li>
</ul>


</body>

</html>
